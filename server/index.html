<!DOCTYPE html>
<html>
  <head>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/three.js/r67/three.min.js"></script>
    <script src="http://js.leapmotion.com/leap-0.6.0.js"></script>
    <script src="http://js.leapmotion.com/leap-plugins-0.1.6.js"></script>
    <script src="http://js.leapmotion.com/leap.rigged-hand-0.1.5.min.js"></script>
    <script src="leapsticks.js"></script>
  </head>
  <body style="background-color:black;">
    <div style="color: white;">
      <span>Enemy left: </span><span id='eleftScore'>1</span>&nbsp;
      <span>Enemy right: </span><span id='erightScore'>1</span>&nbsp;
      <div id="playerturn" style="text-align: center;"></div>
      <button onClick="turn('attack', 'left', 'right')"></button>
      <div style="float: right;">
        <span>My left: </span><span id='leftScore'>1</span>&nbsp;
        <span>My right: </span><span id='rightScore'>1</span>&nbsp;
      </div>
    </div>
    <script>
    (window.controller = new Leap.Controller)
      .use('handHold', {})
      .use('handEntry', {})
      .use('riggedHand',{scale: .5, positionScale: .5})
      .connect()
    </script>
    <script>
      var socket = io();
      var myFingers = [1, 1];
      var myTurn = false;
      var otherFingers = [1, 1];
      document.getElementById('leftScore').innerHtml = '1';
      document.getElementById('rightScore').innerHtml = '1';

      socket.on('update', function(data) {
        console.log('received update'); // Temporary
        if (data.move === 'attack') {
          myFingers[data.to === 'left' ? 0 : 1] += otherFingers[data.from === 'left' ? 0 : 1];
          myFingers[data.to === 'left' ? 0 : 1] %= 5;
          document.getElementById('leftScore').innerHtml = myFingers[0];
          document.getElementById('rightScore').innerHtml = myFingers[1];
          if (myFingers[0] === 0 && myFingers[1] === 0) {
            alert('You lose!!!!');
            socket.disconnect();
          }
        } else if (data.move === 'split') {
          ++otherFingers[data.to === 'left' ? 0 : 1];
          --otherFingers[data.from === 'left' ? 0 : 1];
          document.getElementById('eleftScore').innerHtml = otherFingers[0];
          document.getElementById('erightScore').innerHtml = otherFingers[1];
        }
      });

      var turn = function(move, from, to) {
        // Code goes here
        //console.log("Hello...");
        var json = main(window.controller);
        if (json.data["move"] !== undefined && json.data["from"] !== undefined && json.data["to"] !== undefined) {
            var move = json.data["move"];
            var from = json.data["from"];
            var to = json.data["to"];
            if (move === 'attack') {
                otherFingers[to === 'left' ? 0 : 1] += myFingers[from === 'left' ? 0 : 1];
                otherFingers[to === 'left' ? 0 : 1] %= 5;
                document.getElementById('eleftScore').innerHtml = otherFingers[0];
                document.getElementById('erightScore').innerHtml = otherFingers[1];
            } else if (move === 'split') {
                ++myFingers[to === 'left' ? 0 : 1];
                --myFingers[from === 'left' ? 0 : 1];
                document.getElementById('leftScore').innerHtml = myFingers[0];
                document.getElementById('rightScore').innerHtml = myFingers[1];
                }
                console.log("Calling turn...");
                socket.emit('turn', {move: move, from: from, to: to});
                if (otherFingers[0] === otherFingers[1] === 0) {
                    alert('You win!!!');
                    socket.disconnect();
                }
        }
      }

      socket.on('startGame', function(isFirstPlayer) {
        // Either play first move or wait
        if (isFirstPlayer) {
            console.log("FIRST!");
            myTurn = true;
            document.getElementById("playerturn").innerHtml = "Your turn";
            turn("", "", ""); 
        } else {
            document.getElementById("playerturn").innerHtml = "Wait for your turn";
        }
      });

      socket.on('endGame', function() {
        // Game is over
        socket.disconnect();
      });
    </script>
  </body>
</html>
