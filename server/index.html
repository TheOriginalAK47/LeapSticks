<!DOCTYPE html>
<html>
  <head>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/three.js/r67/three.min.js"></script>
    <script src="http://js.leapmotion.com/leap-0.6.0.js"></script>
    <script src="http://js.leapmotion.com/leap-plugins-0.1.6.js"></script>
    <script src="http://js.leapmotion.com/leap.rigged-hand-0.1.5.min.js"></script>
    <script src="leapsticks.js"></script>
  </head>
  <body style="background-color:black;">
    <div style="color: white; width: 100%;">
      <div style="float: left; width: 33%;">
        <span>Enemy left: </span><span id='eleftScore'>1</span>&nbsp;
        <span>Enemy right: </span><span id='erightScore'>1</span>&nbsp;
      </div>
      <div id="turnIndicator" style="text-align: center; display: inline-block; width: 33%;">Waiting for Match to start</div>
      <div style="text-align: right; float: right; width: 33%;">
        <span>My left: </span><span id='leftScore'>1</span>&nbsp;
        <span>My right: </span><span id='rightScore'>1</span>&nbsp;
      </div>
    </div>
    <script>
      var socket = io();
      var myFingers = [1, 1];
      var myTurn = false;
      var otherFingers = [1, 1];
      document.getElementById('leftScore').innerHTML = '1';
      document.getElementById('rightScore').innerHTML = '1';

      var controller = Leap.loop({}, function(frame) {
        if (myTurn) {
          var json = turnHandler(frame);
          if (json !== undefined && json.data["move"] !== '' && json.data["from"] !== "" && json.data["to"] !== "") {
            turn(json.data['move'], json.data['from'], json.data['to']);
          }
        }
      }).use('riggedHand', {scale: .5, positionScale: .5}).use('handHold', {}).use('handEntry', {});

      socket.on('update', function(data) {
        console.log('received update'); // Temporary
        if (data.move === 'attack') {
          myFingers[data.to === 'left' ? 0 : 1] += otherFingers[data.from === 'left' ? 0 : 1];
          myFingers[data.to === 'left' ? 0 : 1] %= 5;
          document.getElementById('leftScore').innerHTML = myFingers[0];
          document.getElementById('rightScore').innerHTML = myFingers[1];
          if (myFingers[0] === 0 && myFingers[1] === 0) {
            alert('You lose!!!!');
            socket.disconnect();
          }
        } else if (data.move === 'split') {
          ++otherFingers[data.to === 'left' ? 0 : 1];
          --otherFingers[data.from === 'left' ? 0 : 1];
          document.getElementById('eleftScore').innerHTML = otherFingers[0];
          document.getElementById('erightScore').innerHTML = otherFingers[1];
        }
        flipTurn();
      });

      var turn = function(move, from, to) {
        // Code goes here
        if (move === 'attack') {
          otherFingers[to === 'left' ? 0 : 1] += myFingers[from === 'left' ? 0 : 1];
          otherFingers[to === 'left' ? 0 : 1] %= 5;
          document.getElementById('eleftScore').innerHTML = otherFingers[0];
          document.getElementById('erightScore').innerHTML = otherFingers[1];
        } else if (move === 'split') {
          ++myFingers[to === 'left' ? 0 : 1];
          --myFingers[from === 'left' ? 0 : 1];
          document.getElementById('leftScore').innerHTML = myFingers[0];
          document.getElementById('rightScore').innerHTML = myFingers[1];
        }
        flipTurn();
        socket.emit('turn', {move: move, from: from, to: to});
        if (otherFingers[0] === otherFingers[1] === 0) {
          alert('You win!!!');
          socket.disconnect();
        }
      }

      var flipTurn = function() {
        if (myTurn) {
          document.getElementById('turnIndicator').innerHTML = "Opponent's turn";
          myTurn = false;
        } else {
          document.getElementById('turnIndicator').innerHTML = 'Your turn';
          myTurn = true;
        }
      }
      socket.on('startGame', function(isFirstPlayer) {
        if (isFirstPlayer) {
          flipTurn(); 
        } else {
          document.getElementById('turnIndicator').innerHTML = "Opponent's turn";
          myTurn = false;
        }
      });

      socket.on('endGame', function() {
        // Game is over
        document.getElementById('turnIndicator').innerHTML = "Game over";
        socket.disconnect();
      });
    </script>
  </body>
</html>
